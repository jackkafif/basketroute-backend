<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BasketRoute Optimizer</title>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-bg: #f8fafd;
            --accent: #7f56d9;
            --accent-light: #f4ebff;
            --text-main: #23272f;
            --border: #ececec;
            --success: #daf5db;
            --card-bg: #f9fafb;
            --selected-bg: #ede9fe;
            --selected-border: #7c3aed;
        }
        html, body {
            background: var(--main-bg);
            font-family: 'Inter', Arial, sans-serif;
            color: var(--text-main);
            margin: 0; padding: 0;
        }
        .container {
            max-width: 480px;
            margin: 48px auto;
            padding: 36px 32px 32px 32px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(80, 88, 108, 0.10);
        }
        h2 {
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.7rem;
            letter-spacing: -1px;
        }
        label {
            margin: 18px 0 6px 0;
            display: block;
            font-weight: 500;
        }
        .select-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        .pill-card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 11px 17px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.16s, border 0.18s, box-shadow 0.18s;
            user-select: none;
            outline: none;
        }
        .pill-card.selected {
            background: var(--selected-bg);
            border-color: var(--selected-border);
            color: var(--selected-border);
            box-shadow: 0 2px 10px 0 var(--accent-light);
        }
        button[type=submit] {
            width: 100%;
            padding: 13px 0;
            margin-top: 24px;
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            border: none;
            border-radius: 11px;
            font-size: 1.12rem;
            cursor: pointer;
            transition: background 0.2s;
            letter-spacing: 0.02em;
            box-shadow: 0 2px 12px 0 var(--accent-light);
        }
        button[type=submit]:hover {
            background: #6941c6;
        }
        .result {
            margin-top: 30px;
        }
        .plan-card {
            background: var(--success);
            border-radius: 11px;
            padding: 19px 18px 15px 18px;
            margin-bottom: 14px;
            border: 1.5px solid #b9e2c4;
        }
        .plan-card h4 {
            margin: 0 0 8px 0;
            font-size: 1.14rem;
            font-weight: 600;
        }
        .plan-list {
            list-style: disc inside;
            margin: 0;
            padding-left: 13px;
        }
        .error {
            color: #bb1717;
            background: #ffebee;
            padding: 11px 15px;
            border-radius: 9px;
            margin-top: 10px;
            border: 1.5px solid #ffd8dd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>BasketRoute Optimizer</h2>
        <form id="optimize-form" autocomplete="off">
            <label for="stores">Select Stores</label>
            <div id="stores-grid" class="select-grid"></div>

            <label for="items">Select Items</label>
            <div id="items-grid" class="select-grid"></div>

            <button type="submit">Optimize Route</button>
        </form>
        <div class="result" id="result"></div>
    </div>
    <script>
        // Handle selectable pill cards
        function makeSelectablePills(containerId, options, selectedSet) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            options.forEach(opt => {
                const card = document.createElement('div');
                card.className = 'pill-card';
                card.tabIndex = 0;
                card.textContent = opt;
                card.onclick = () => {
                    if (selectedSet.has(opt)) {
                        selectedSet.delete(opt);
                        card.classList.remove('selected');
                    } else {
                        selectedSet.add(opt);
                        card.classList.add('selected');
                    }
                };
                card.onkeydown = e => {
                    if (e.key === " " || e.key === "Enter") {
                        card.click();
                        e.preventDefault();
                    }
                };
                container.appendChild(card);
            });
        }

        // State for selections
        const selectedStores = new Set();
        const selectedItems = new Set();

        // Fetch stores and items on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const storesRes = await fetch('/api/all_stores');
            const stores = await storesRes.json();
            makeSelectablePills('stores-grid', stores.map(s => s.name), selectedStores);

            const itemsRes = await fetch('/api/products');
            const items = await itemsRes.json();
            makeSelectablePills('items-grid', items.map(i => i.name), selectedItems);
        });

        // Pretty print the plan and cost (updated for new plan format)
        function showPlanAndCost(response) {
            const plan = response.plan;
            const cost = response.cost;
            const status = response.status || '';
            const container = document.createElement('div');

            // Show cost at top
            const costDiv = document.createElement('div');
            costDiv.style.fontWeight = "bold";
            costDiv.style.fontSize = "1.15rem";
            costDiv.style.marginBottom = "10px";
            costDiv.textContent = `Total Cost: $${cost.toFixed(2)}`;
            container.appendChild(costDiv);

            // Show status if present
            if (status) {
                const statusDiv = document.createElement('div');
                statusDiv.style.fontWeight = "500";
                statusDiv.style.fontSize = "1.01rem";
                statusDiv.style.marginBottom = "18px";
                statusDiv.textContent = `Status: ${status}`;
                container.appendChild(statusDiv);
            }

            // Show each store and items with quantity
            Object.keys(plan).forEach(store => {
                const card = document.createElement('div');
                card.className = 'plan-card';
                const h4 = document.createElement('h4');
                h4.textContent = store;
                card.appendChild(h4);

                const ul = document.createElement('ul');
                ul.className = 'plan-list';
                plan[store].forEach(entry => {
                    const li = document.createElement('li');
                    li.textContent = entry.quantity > 1 
                        ? `${entry.item} (x${entry.quantity})`
                        : entry.item;
                    ul.appendChild(li);
                });
                card.appendChild(ul);
                container.appendChild(card);
            });
            return container;
        }

        // Handle form submission
        document.getElementById('optimize-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = "";

            if (selectedStores.size === 0 || selectedItems.size === 0) {
                resultDiv.innerHTML = '<div class="error">Please select at least one store and one item.</div>';
                return;
            }

            const res = await fetch('/api/optimize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stores: Array.from(selectedStores),
                    items: Array.from(selectedItems)
                })
            });

            if (res.ok) {
                const data = await res.json();
                if (data && typeof data === "object" && data.plan && Object.keys(data.plan).length) {
                    resultDiv.innerHTML = '';
                    resultDiv.appendChild(showPlanAndCost(data));
                } else {
                    resultDiv.innerHTML = '<div class="error">No plan returned by optimizer.</div>';
                }
            } else {
                resultDiv.innerHTML = '<div class="error">Optimization failed. Please try again.</div>';
            }
        });
    </script>
</body>
</html>
